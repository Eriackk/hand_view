<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>hand_view</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; margin: 20px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .panel { width: 100%; aspect-ratio: 16/9; background: #111; border-radius: 12px; overflow: hidden; position: relative; }
    canvas { width: 100%; height: 100%; display: block; }
    .status { margin-top: 12px; color: #333; font-size: 14px; }
    .hint { margin-top: 6px; color: #666; font-size: 13px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <canvas id="canvas"></canvas>
    </div>
    <div class="status" id="status">状态：初始化中...</div>
    <div class="hint">说明：页面会自动请求摄像头权限，并在浏览器本地实时绘制手部关键点与骨架，不上传视频。</div>
  </div>

  <video id="video" playsinline style="display:none;"></video>

  <script type="module">
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const video = document.getElementById("video");
    const statusEl = document.getElementById("status");

    function setStatus(t) { statusEl.textContent = "状态：" + t; }

    let stream = null;
    let rafId = null;

    let vision = null;
    let FilesetResolver = null;
    let HandLandmarker = null;
    let DrawingUtils = null;

    let handLandmarker = null;
    let drawingUtils = null;

    function resizeCanvasToVideo() {
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      if (canvas.width !== w) canvas.width = w;
      if (canvas.height !== h) canvas.height = h;
    }

    async function initMediaPipe() {
      setStatus("加载 MediaPipe（JS/WASM/模型）...");
      // 动态 import：避免 CDN 加载失败导致整页脚本失效
      vision = await import("https://unpkg.com/@mediapipe/tasks-vision@0.10.14");
      ({ FilesetResolver, HandLandmarker, DrawingUtils } = vision);

      const fileset = await FilesetResolver.forVisionTasks(
        "https://unpkg.com/@mediapipe/tasks-vision@0.10.14/wasm"
      );

      handLandmarker = await HandLandmarker.createFromOptions(fileset, {
        baseOptions: { modelAssetPath: "./hand_landmarker.task" }, // 与 index.html 同目录
        runningMode: "VIDEO",
        numHands: 2,
        minHandDetectionConfidence: 0.5,
        minHandPresenceConfidence: 0.5,
        minTrackingConfidence: 0.5
      });

      drawingUtils = new DrawingUtils(ctx);
      setStatus("MediaPipe 就绪");
    }

    async function openCamera() {
      setStatus("请求摄像头权限中...");
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      resizeCanvasToVideo();
      setStatus("摄像头已开启，识别中...");
    }

    function loop() {
      resizeCanvasToVideo();

      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 镜像显示（自拍习惯）
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const nowMs = performance.now();
      const result = handLandmarker.detectForVideo(video, nowMs);

      if (result.landmarks && result.landmarks.length > 0) {
        for (const lm of result.landmarks) {
          drawingUtils.drawConnectors(lm, HandLandmarker.HAND_CONNECTIONS);
          drawingUtils.drawLandmarks(lm, { radius: 3 });
        }
      }

      ctx.restore();
      rafId = requestAnimationFrame(loop);
    }

    async function main() {
      try {
        // 先初始化识别，再开摄像头；这样一开就能画
        await initMediaPipe();
        await openCamera();
        loop();
      } catch (e) {
        console.error(e);
        // 常见失败：相机权限拒绝 / CDN 被拦 / 模型路径不对
        if (String(e).toLowerCase().includes("permission") || String(e).toLowerCase().includes("denied")) {
          setStatus("摄像头权限被拒绝（请在浏览器地址栏相机图标里允许）");
        } else if (String(e).toLowerCase().includes("hand_landmarker.task")) {
          setStatus("模型加载失败（确认 hand_landmarker.task 与 index.html 同目录且文件名一致）");
        } else {
          setStatus("初始化失败（打开控制台查看错误：可能是网络/CDN/WASM）");
        }
      }
    }

    // 页面关闭时释放摄像头
    window.addEventListener("beforeunload", () => {
      if (rafId) cancelAnimationFrame(rafId);
      if (stream) stream.getTracks().forEach(t => t.stop());
    });

    // 自动启动
    main();
  </script>
</body>
</html>
