<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>hand_view_whiteboard</title>
<style>
:root{
  --bg:#000; --fg:#eee;
  --card:rgba(255,255,255,0.08);
  --card2:rgba(255,255,255,0.10);
  --bd:rgba(255,255,255,0.12);
  --bd2:rgba(255,255,255,0.18);
  --bd3:rgba(255,255,255,0.28);
  --mut:rgba(255,255,255,0.72);
}
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  overflow:hidden;
  user-select:none;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
}
.app{
  height:100vh;
  display:grid;
  grid-template-columns:15% 70% 15%;
  gap:14px;
  padding:14px;
}
.left,.right{ min-width:260px; }
.center{ min-width:520px; display:flex; flex-direction:column; gap:10px; }
.box{
  border-radius:14px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.10);
  padding:12px;
  height:100%;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.boxTitle{ font-size:13px; color:rgba(255,255,255,0.85); margin:0; }
.panel{ flex:1; position:relative; border-radius:14px; overflow:hidden; }
.panel canvas{ position:absolute; inset:0; width:100%; height:100%; }
.statusbar{
  display:flex; gap:10px; padding:10px;
  border-radius:12px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.10);
}
.badge{ padding:6px 10px; border-radius:999px; background:var(--card); font-size:13px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; }
.btn{
  padding:8px 12px;
  border-radius:10px;
  background:var(--card2);
  border:1px solid var(--bd2);
  color:#eee;
  font-size:13px;
  cursor:pointer;
}
.btn.on{ background:rgba(255,255,255,0.22); border-color:var(--bd3); }
</style>
</head>

<body>
<div class="app">
  <div class="left"><div class="box"><p class="boxTitle">说明</p></div></div>

  <div class="center">
    <div class="panel" id="panel">
      <canvas id="viewCanvas"></canvas>
      <canvas id="drawCanvas"></canvas>
      <canvas id="uiCanvas"></canvas>
    </div>
    <div class="statusbar">
      <span class="badge" id="state">初始化中</span>
    </div>
  </div>

  <div class="right">
    <div class="box">
      <p class="boxTitle">控制</p>
      <div class="row">
        <button class="btn on" id="skeletonBtn">骨架：开</button>
      </div>
    </div>
  </div>
</div>

<video id="video" playsinline style="display:none;"></video>

<script type="module">
const panel = document.getElementById("panel");
const viewCanvas = document.getElementById("viewCanvas");
const drawCanvas = document.getElementById("drawCanvas");
const uiCanvas = document.getElementById("uiCanvas");
const vctx = viewCanvas.getContext("2d");
const dctx = drawCanvas.getContext("2d");
const uctx = uiCanvas.getContext("2d");
const video = document.getElementById("video");
const stateEl = document.getElementById("state");
const skeletonBtn = document.getElementById("skeletonBtn");

let showSkeleton = true;
skeletonBtn.onclick = ()=>{
  showSkeleton = !showSkeleton;
  skeletonBtn.textContent = showSkeleton ? "骨架：开" : "骨架：关";
  skeletonBtn.classList.toggle("on", showSkeleton);
};

const DPR = Math.max(1, devicePixelRatio || 1);
let penW = 2.8;
let penColor = "#30d158";
let prevPt=null, prevMid=null;

function resize(){
  const r=panel.getBoundingClientRect();
  const W=r.width*DPR, H=r.height*DPR;
  [viewCanvas,drawCanvas,uiCanvas].forEach(c=>{
    if(c.width!==W){ c.width=W; c.height=H; }
  });
}

function drawPenTip(pt){
  uctx.save();
  uctx.fillStyle="rgba(255,255,255,0.95)";
  uctx.beginPath();
  uctx.arc(pt.x,pt.y,4.5*DPR,0,Math.PI*2);
  uctx.fill();
  uctx.restore();
}

function addStroke(p){
  if(!prevPt){
    prevPt=p; prevMid=p; return;
  }
  const mid={x:(p.x+prevPt.x)/2,y:(p.y+prevPt.y)/2};
  dctx.strokeStyle=penColor;
  dctx.lineWidth=penW*DPR;
  dctx.lineCap="round";
  dctx.lineJoin="round";
  dctx.beginPath();
  dctx.moveTo(prevMid.x,prevMid.y);
  dctx.quadraticCurveTo(prevPt.x,prevPt.y,mid.x,mid.y);
  dctx.stroke();
  prevPt=p; prevMid=mid;
}

function drawSkeleton(lm,w,h){
  if(!showSkeleton) return;
  const pts=lm.map(p=>({x:p.x*w,y:p.y*h}));
  vctx.save();
  vctx.strokeStyle="rgba(120,160,190,0.55)";
  vctx.lineWidth=2.2*DPR;
  [[0,5],[5,9],[9,13],[13,17],[17,0]].forEach(([a,b])=>{
    vctx.beginPath(); vctx.moveTo(pts[a].x,pts[a].y); vctx.lineTo(pts[b].x,pts[b].y); vctx.stroke();
  });
  vctx.strokeStyle="rgba(160,190,210,0.65)";
  vctx.lineWidth=3.4*DPR;
  [[0,1],[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[9,10],[10,11],[11,12],[13,14],[14,15],[15,16],[17,18],[18,19],[19,20]].forEach(([a,b])=>{
    vctx.beginPath(); vctx.moveTo(pts[a].x,pts[a].y); vctx.lineTo(pts[b].x,pts[b].y); vctx.stroke();
  });
  vctx.fillStyle="rgba(200,220,235,0.85)";
  pts.forEach(p=>{ vctx.beginPath(); vctx.arc(p.x,p.y,3.5*DPR,0,Math.PI*2); vctx.fill(); });
  vctx.restore();
}

async function main(){
  const vision = await import("https://unpkg.com/@mediapipe/tasks-vision@0.10.14");
  const {HandLandmarker,FilesetResolver}=vision;
  const fs = await FilesetResolver.forVisionTasks("https://unpkg.com/@mediapipe/tasks-vision@0.10.14/wasm");
  const hl = await HandLandmarker.createFromOptions(fs,{
    baseOptions:{modelAssetPath:"./hand_landmarker.task"},
    runningMode:"VIDEO", numHands:2
  });
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream; await video.play();

  function loop(){
    resize();
    vctx.clearRect(0,0,viewCanvas.width,viewCanvas.height);
    vctx.drawImage(video,0,0,viewCanvas.width,viewCanvas.height);
    const res=hl.detectForVideo(video,performance.now());
    if(res.landmarks){
      res.landmarks.forEach(lm=>{
        drawSkeleton(lm,viewCanvas.width,viewCanvas.height);
        const p8=lm[8], p12=lm[12];
        const mid={x:(p8.x+p12.x)/2*viewCanvas.width,y:(p8.y+p12.y)/2*viewCanvas.height};
        addStroke(mid);
        drawPenTip(mid);
      });
    }
    requestAnimationFrame(loop);
  }
  loop();
}
main();
</script>
</body>
</html>
